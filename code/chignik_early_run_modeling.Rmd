---
title: "Chignik Early Run Modeling"
author: "Sarah Power"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: pdf_document
---

# Recipients
Heather Finkle,
Birch Foster,
Kevin Schaberg.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```
```{r data entry}
# load ----
library(zoo) # to convert numeric date back to a number
source('distribution_functions.R')

# data ----
chig_data <- read_csv('../data/ChigISGrunappt2006-2017catch.by.district.csv') %>% 
  dplyr::select(-Earlycatch, -Latecatch, -Earlytotal, -Latetotal) %>%
  rename(#date = Date,
         prop_early_genetics = Propotionearly, 
         early_esc_genetics = Earlyesc, 
         late_esc_genetics = Lateesc,
         #early_catch_genetics = Earlycatch,
         #late_catch_genetics = Latecatch,
         #early_total_genetics = Earlytotal,
         #late_total_genetics = Latetotal,
         chignik = Chignik_Hook_Kujulik) %>%
  mutate(esc = early_esc_genetics + late_esc_genetics,
         #catch = early_catch_genetics + late_catch_genetics,
         catch_chignik = Lagoon + chignik,
         run = esc + catch_chignik, #catch is our estimate of what would have occured at the wier had there been no fishing, based on migration timing studies.
         run_early_gen = prop_early_genetics*run,
         date = mdy(Date),
         day_of_year = yday(date)) #-> chig_data # convert the Date to its numeric equivalent

read_csv('../data/ChigISGrunappt2006-2017.csv') %>% 
  dplyr::select(-X9) %>%
  rename(prop_early_genetics = Propotionearly, 
         early_esc_genetics = Earlyesc, 
         late_esc_genetics = Lateesc,
         early_catch_genetics = Earlycatch,
         late_catch_genetics = Latecatch,
         early_total_genetics = Earlytotal,
         late_total_genetics = Latetotal) %>%
  mutate(esc = early_esc_genetics + late_esc_genetics,
         catch = early_catch_genetics + late_catch_genetics,
         run = esc + catch, #catch is our estimate of what would have occured at the wier had there been no fishing, based on migration timing studies.
         run_early_gen = prop_early_genetics*run,
         date = mdy(Date),
         day_of_year = yday(date)) -> weir_data # convert the Date to its numeric equivalent

year_vector <- c(2006:2008,2010:2017)
```


## Chignik Sockeye Early Run Timing
# Background

For over a decade genetic samples of sockeye (Oncorhynchus nerka) have been collected at the Chignik weir which has distinguished the early run, which mostly spawns in Black Lake from later runs. The majority of these later runs spawn in Chignik Lake. Currently these two stocks are managed separately. The processing of genetics samples is expensive, and so alternative methods for distinguishing between the stocks are being examined. In the years prior to genetic assignment July 4th was used as a cut off date between the early and late runs with the understanding that some early run fish arrive later and some later run fish arrive earlier.

This analysis will examine the runtiming distributions to determine how well early run stocks can be discerned from the later ones on runtiming alone. We will compare this to the runtiming distributions to those that are determined with the additional aid of genetics to see how viable this method might be. To determine which model is most appropriate and how viable this method is, similarity to the mean and standard deviation of the early run and number of sockeye in the early run as determined with the additional aid of genetics will be used .   

Currently the run is the sum of the escapement at the weir, and catch from various multiple management districts, some of which are quite far away. 

# Methods

Creelman (2011) hypothesized that the early run and later runs are comprised of various smaller runs with their own runtiming and run locations.She found that run timing played an important role in genetic variation, which makes distinguishing run based on runtiming a possibility. She grouped collections into four genetic groups: Black Lake, Chignik Lake, Chignik Lake October, and Chingnik River. Looking at the runtiming distributions from 2006 to present there appears to be three distributions. Noting that data from the weir is collected from about late may until the end of September, and that Creelman noted an October Chignik Lake run the assumption we will take is that there is a biological reason for three distribution to be presented in the data, which were modeled in the analysis.

I used maximum likelihood methods, including the EM algorithm and a Newton-type algorithm to parse out various distributions using the 'mixdist' package in R. In initial investigations Normal and Weibull distributions were fit. Also Normal distributions with certain constraints were considered in order to find the best fit. Those constraints included equal standard errors; means equally spaced, and having the mean or standard error of the early distribution fixed a particular mean or standared error.  The fixed means and standard errors were the median values from the early distribution determined using genetics.

It was determined that the most appropriate fitting model was a three distribution normally-distributed model with the constraint of equal standard deviations for each of the distributions. This was determined as this model had an early run with a mean and standard deviation most like the early run as determined with genetics.

Once this model was determined to be most appropriate the run counts of each of the years were examined in order to determine if the model could be useful. For 8 of the 11 years between 2006 and 2017 early run counts using runtiming alone were within 10% of the counts using genetic information. The three best years included 2010, 2013, and 2014, where early run counts using runtiming information alone differed by no more than 3% of the counts using additional genetic information. 

```{r three_best}
auto_year(weir_data, 2010)
year_stats(weir_data, 2010)

auto_year(weir_data, 2013)
year_stats(weir_data, 2013)

auto_year(weir_data, 2014)
year_stats(weir_data, 2014)

#a10 <- auto_year(weir_data, 2010)
#y10 <- year_stats(weir_data, 2010)
#ay10 <- cowplot::plot_grid(a10, y10, ncol = 1, align = "hv")
#a13 <- auto_year(weir_data, 2013)
#y13 <- year_stats(weir_data, 2013)
#ay13 <- cowplot::plot_grid(a13, y13, ncol = 1, align = "hv")
#a14 <- auto_year(weir_data, 2014)
#y14 <- year_stats(weir_data, 2014)
#ay14 <- cowplot::plot_grid(a14, y14, ncol = 1, align = "hv")

#cowplot::plot_grid(c(ay10, ay3, ay14), ncol = 3)

```

The three years that runtiming distributions were off by more than 10% included 2008, which overestimated the early run by 27%, 2015 where it underestimated the early run by 25% and 2012 where is over estimated the run by a whopping 67%. 

```{r three_worst}
auto_year(weir_data, 2008)
year_stats(weir_data, 2008)
auto_year(weir_data, 2012)
year_stats(weir_data, 2012)
auto_year(weir_data, 2015)
year_stats(weir_data, 2015)

```

It was suggested by Heather Finkle that using catch information from farther flung districts might add noise to the distributions since those districts surely would contain harvest from non-Chignik stocks. The analysis was reexamined this time using only harvests that were a day or twos fish-swim away. 

This change improved the model. The most significant change being that of the year 2012 which changed from an over estimate of 67% to an over estimate of 5%, which is much more reasonable. The 2008 and 2015 estimates were similar with a 25% over estimate and 26% underestimate respectively.

```{r even_better}
auto_year(chig_data, 2012)
year_stats(chig_data, 2012)
```
# Recommendations/Discussion

Future analysis could include examining if there are any factors that explain why 2008 and 2015 preformed poorly with the model. Initial investigations note that the mean day-of-year for early runtiming is shifted to the right 3 days for 2008 and 2 days for 2015, indicating that the estimated distribution is pulled to the right of what it would be using additional genetic information. Biologists note that harvest and runsize may have been different. Also examining time and area harvest to include in runtime estimates may improve the model. 

It is important to note that the definition of the run, at least in terms of this model, changed from what is currently used. Harvest farther from the Chignik area were excluded. If this model, or one like it were used in the future it should be determined if the run estimates for this model are only to distinguish the percentage of early vs late run stocks (recommended for near term), or if the methods behind estimates of harvest should be reexamined, (recommended for the future).

# Results

Below are the graphs for all the years using model with the more conservative data set:

```{r all_year_graphs}
auto_year(chig_data, 2006)
year_stats(chig_data, 2006)
auto_year(chig_data, 2007)
year_stats(chig_data, 2007)
auto_year(chig_data, 2008)
year_stats(chig_data, 2008)
auto_year(chig_data, 2010)
year_stats(chig_data, 2010)
auto_year(chig_data, 2011)
year_stats(chig_data, 2011)
auto_year(chig_data, 2012)
year_stats(chig_data, 2012)
auto_year(chig_data, 2013)
year_stats(chig_data, 2013)
auto_year(chig_data, 2014)
year_stats(chig_data, 2014)
auto_year(chig_data, 2015)
year_stats(chig_data, 2015)
auto_year(chig_data, 2016)
year_stats(chig_data, 2016)
auto_year(chig_data, 2017)
year_stats(chig_data, 2017)

#year_vector <- c(2006:2008,2010:2017)

#for(i in year_vector){
#  auto_year(chig_data, i)
#  year_stats(chig_data, i)
#}
#year_stats(weir_data, 2015)
```

# Citation

Elisabeth K. Creelman, Lorenz Hauser, Ryan K. Simmons, William D. Templin & Lisa W. Seeb (2011):
Temporal and Geographic Genetic Divergence: Characterizing Sockeye Salmon Populations in the Chignik Watershed, Alaska,
Using Single-Nucleotide Polymorphisms, Transactions of the American Fisheries Society, 140:3, 749-762

link: http://dx.doi.org/10.1080/00028487.2011.584494

# R Session Info
```{r sess_info, echo=FALSE}
sessionInfo()
```

